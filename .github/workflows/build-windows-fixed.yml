name: Build Windows Executable (Fixed)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check project structure
      run: |
        Write-Host "=== æ£€æŸ¥é¡¹ç›®ç»“æ„ ==="
        Get-ChildItem -Recurse -Name | Where-Object { $_ -match "(main\.go|go\.mod|\.yml$)" } | ForEach-Object { Write-Host "Found: $_" }

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: |
        Write-Host "=== ä¸‹è½½ä¾èµ– ==="
        if (Test-Path "go.mod") {
          go mod download
          Write-Host "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"
        } elseif (Test-Path "gui_app/go.mod") {
          Write-Host "ğŸ“ å‘ç°gui_appå­ç›®å½•ï¼Œåˆ‡æ¢åˆ°è¯¥ç›®å½•"
          Set-Location gui_app
          go mod download
          Write-Host "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"
        } else {
          Write-Host "âŒ æœªæ‰¾åˆ°go.modæ–‡ä»¶"
          exit 1
        }

    - name: Build executable
      run: |
        Write-Host "=== å¼€å§‹æ„å»º ==="
        if (Test-Path "main.go") {
          Write-Host "ğŸ“„ åœ¨æ ¹ç›®å½•æ‰¾åˆ°main.go"
          go build -o "èŒä¸šç§¯åˆ†ç®¡ç†ç³»ç»Ÿ.exe" main.go
        } elseif (Test-Path "gui_app/main.go") {
          Write-Host "ğŸ“ åœ¨gui_appç›®å½•æ‰¾åˆ°main.go"
          Set-Location gui_app
          go build -o "èŒä¸šç§¯åˆ†ç®¡ç†ç³»ç»Ÿ.exe" main.go
        } else {
          Write-Host "âŒ æœªæ‰¾åˆ°main.goæ–‡ä»¶"
          Get-ChildItem -Recurse -Name | Where-Object { $_ -match "main\.go" }
          exit 1
        }

        if (Test-Path "èŒä¸šç§¯åˆ†ç®¡ç†ç³»ç»Ÿ.exe") {
          $size = (Get-Item "èŒä¸šç§¯åˆ†ç®¡ç†ç³»ç»Ÿ.exe").Length / 1MB
          Write-Host "âœ… æ„å»ºæˆåŠŸï¼æ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ æ„å»ºå¤±è´¥"
          exit 1
        }

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable-fixed
        path: |
          èŒä¸šç§¯åˆ†ç®¡ç†ç³»ç»Ÿ.exe
          gui_app/èŒä¸šç§¯åˆ†ç®¡ç†ç³»ç»Ÿ.exe
        if-no-files-found: warn
        retention-days: 30
